---
title: "R Notebook"
output: html_notebook
---
# Libraries
```{r}
library(tidyverse)
library(janitor)
library(lubridate)
library(GGally)
```

# Reading in data
```{r}
# loading data
loans <- read_csv("../data/lending_club_loans.csv")
grades <- read_csv("../data/grade_info.csv")
states_info <- read_csv("../data/state_names_info.csv")
```

# Joining df's
```{r}
# joining df's
loans <- loans %>% 
  rename(state_abb = addr_state) %>% 
  left_join(states_info, by = "state_abb") %>% 
  left_join(grades, by = "sub_grade") %>% 
  clean_names() 

rm(states_info, grades)
```

# Cleaning
```{r}
# investigating data
summary(loans)

# checking na's
loans %>% 
 summarise(across(.fns = ~ sum(is.na(.x))))

# removing vars with no predictive power and vars that are all na's
# all bar 1 record had a payment plan in  pymnt_plan, so removing var
loans_trim <- loans %>% 
  filter(!is.na(id) | !is.na(state_abb)) %>% 
  select(-c("id", "member_id", "funded_amnt", "funded_amnt_inv", "desc", "title", 
            "url", "application_type",
            "delinq_amnt", "tax_liens", "acc_now_delinq", "chargeoff_within_12_mths",
            "policy_code", "collections_12_mths_ex_med", "last_fico_range_low",
            "last_fico_range_high", "next_pymnt_d", "last_credit_pull_d",
            "last_pymnt_d", "last_pymnt_amnt", "initial_list_status", 
            "mths_since_last_record", "fico_range_high", "state_abb", "zip_code",
            "pymnt_plan", "desc", "title", "recoveries", "state_abb", )) %>% 
  select_if(~ !all(is.na(.))) %>% 
  mutate(defaulted = if_else(  # new col, classing loan defaulted if late, charged off or defaulted
    loan_status %in% c("Charged Off",
                       "Does not meet the credit policy. Status:Charged Off",
                       "Late (31-120 days)",
                       "Late (16-30 days)",
                       "Default"), TRUE, FALSE), 
    .after = loan_status) %>% 
  mutate(issue_d = my(issue_d),       # changing date var from chr to date
         earliest_cr_line = my(earliest_cr_line))

# checking na's
loans_trim %>% 
 summarise(across(.fns = ~ sum(is.na(.x))))
```

# Splitting data into background_check data
```{r}
# selecting vars used during the background checks of customer

background_checks <- loans %>% 
  select(c(verification_status, # category - verified income
           dti, # dbl - LC ratio on monthly debts/monthly income
           delinq_2yrs,# dbl - The number of 30+  delinquency in the borrower's credit file for the past 2 years
           earliest_cr_line, # dbl - The month the borrower's earliest reported credit line was opened
           fico_range_low, # dbl - credit score at loan origin
           inq_last_6mths, # dbl - The number of inquiries in past 6 months (excluding auto and mortgage inquiries)
           mths_since_last_delinq, # dbl - The number of months since the borrower's last delinquency.(lc??)
           mths_since_last_record, # The number of months since the last public record.
           open_acc, # dbl - The number of open credit lines in the borrower's credit file.
           pub_rec, # dbl - The number of open credit lines in the borrower's credit file.
           revol_bal, # dbl - Total credit revolving balance  unpaid credit at the end of a billing cycle
           revol_util, # chr - %, amount of credit the borrower is using relative to all available revolving credit
           total_acc, # dbl - The total number of credit lines currently in the borrower's credit file
           open_rv_12m, # boolean - number of revolving credit cards <12mths, full of NA
           open_rv_24m, ## boolean - number of revolving credit cards <24mths, full of NA
           max_bal_bc, # boolean - Maximum current balance owed on all revolving accounts, full of NA
           all_util, # boolean - Balance to credit limit on all trades
           total_rev_hi_lim, # boolean - Total revolving high credit/credit limit, full of NA
           inq_fi, # boolean - Number of personal finance inquiries, full of NA
           total_cu_tl, # boolean - Number of finance trades, full of NA
           inq_last_12m, # boolean - Number of credit inquiries in past 12 months, full of NA
           acc_open_past_24mths, # boolean -  Number of trades opened in past 24 months, full of NA
           avg_cur_bal, # boolean - Average current balance of all accounts, full of NA
           bc_open_to_buy, # boolean - Total open to buy on revolving bankcards, full of NA
           bc_util, # boolean - Ratio of total current balance to high credit/credit limit for all bankcard accounts, full of NA
           chargeoff_within_12_mths, # dbl - Number of charge-offs within 12 months, 0 for all obs
           delinq_amnt, # dbl - The past-due amount owed for the accounts on which the borrower is now delinquent, 6053 + 27, 0
           mo_sin_old_il_acct, # boolean - Months since oldest bank installment account opened, full of NA
           mo_sin_old_rev_tl_op, # boolean - Months since oldest revolving account opened, full of NA
           mo_sin_rcnt_rev_tl_op, # boolean - Months since most recent revolving account opened, full of NA
           mo_sin_rcnt_tl, # boolean - Months since most recent account opened, full of NA
           mort_acc, # boolean - Number of mortgage accounts, full of NA
           mths_since_recent_bc, # boolean - Months since most recent bankcard account opened, full of NA
           mths_since_recent_bc_dlq, # boolean - Months since most recent bankcard delinquency, full of NA
           mths_since_recent_inq, # boolean - Months since most recent inquiry.
           mths_since_recent_revol_delinq, # boolean - Months since most recent revolving delinquency, full of NA
           num_accts_ever_120_pd, # boolean - Number of accounts ever 120 or more days past due, full of NA
           num_actv_bc_tl, # boolean - 	Number of currently active bankcard accounts, full of NA
           num_actv_rev_tl, # boolean - 	Number of currently active revolving trades, full of NA
           num_bc_sats, # boolean -  Number of satisfactory bankcard accounts, full of NA
           num_bc_tl, # boolean -  Number of bankcard accounts, full of NA
           num_il_tl, # boolean -  Number of installment accounts, full of NA
           num_op_rev_tl, # boolean -  Number of open revolving accounts, full of NA
           num_rev_accts, # boolean - 	Number of revolving accounts, full of NA
           num_rev_tl_bal_gt_0, # boolean -	Number of revolving trades with balance >0, full of NA
           num_sats, # boolean - Number of satisfactory accounts, full of NA
           num_tl_120dpd_2m, # boolean - Number of accounts currently 120 days past due (updated in past 2 months), full of NA
           num_tl_30dpd, # boolean - Number of accounts currently 30 days past due (updated in past 2 months), full of NA
           num_tl_90g_dpd_24m, # boolean - Number of accounts 90 or more days past due in last 24 months, full of NA
           num_tl_op_past_12m, # boolean - Number of accounts opened in past 12 months, full of NA
           open_acc_6m,
           open_acc_6m,
           open_il_12m,
           open_il_24m,
           open_il_6m,
           mths_since_rcnt_il, 
           total_bal_il, 
           il_util,
           pct_tl_nvr_dlq,
           pub_rec_bankruptcies,
           tax_liens,
           tot_hi_cred_lim,
           total_bal_ex_mort,
           )) 

# removing variables that are only NA
background_checks_trimmed <- background_checks %>%
  select_if(~ !all(is.na(.)))
```

# Splitting data into onramp_data 
```{r}
loans %>% 
  distinct(tot_cur_bal)
# selecting vars used during on ramp phase of delivering loans
# not including funded/inv due to no use
onramp_data  <- loans %>% 
  select(c(loan_amnt,
           term,
           int_rate,
           installment,
           sub_grade, # LC assigned loan subgrade, can use grade
           emp_title, # chr - not really usefull
           emp_length, # chr - years, should turn to factor and use as bins/dummy
           home_ownership, # chr - binned
           annual_inc, # dbl
           issue_d,
           loan_status,
           pymnt_plan, # chr - turn logical
           desc, # chr - text, no use
           purpose, # chr - binned - turn to factor
           title, # chr - user text to describe loan
           zip_code, # chr - usefull for binning, redacted
           state_name, # chr - turn to factor, no need for abbreviated var
           fico_range_low,
           fico_range_high, 
           application_type, # chr - should bin solo or co-borrower - all IND, some NA
           annual_inc_joint,# remove as all na
           dti_joint,# remove as all na
           verification_status_joint,# remove as all na
           tot_coll_amt,# remove as all na
           tot_cur_bal,# remove as all na
           open_acc_6m,# remove as  as all 
           open_acc_6m,# remove as all na
           open_il_12m,# remove as all na
           open_il_24m,# remove as all na
           open_il_6m,# remove as all na
  ))
```


```{r}
loans %>% 
  select(-c(verification_status, # category - verified income
           dti, # dbl - LC ratio on monthly debts/monthly income
           delinq_2yrs,# dbl - The number of 30+  delinquency in the borrower's credit file for the past 2 years
           earliest_cr_line, # dbl - The month the borrower's earliest reported credit line was opened
           fico_range_low, # dbl - credit score at loan origin
           inq_last_6mths, # dbl - The number of inquiries in past 6 months (excluding auto and mortgage inquiries)
           mths_since_last_delinq, # dbl - The number of months since the borrower's last delinquency.(lc??)
           mths_since_last_record, # The number of months since the last public record.
           open_acc, # dbl - The number of open credit lines in the borrower's credit file.
           pub_rec, # dbl - The number of open credit lines in the borrower's credit file.
           revol_bal, # dbl - Total credit revolving balance  unpaid credit at the end of a billing cycle
           revol_util, # chr - %, amount of credit the borrower is using relative to all available revolving credit
           total_acc, # dbl - The total number of credit lines currently in the borrower's credit file
           open_rv_12m, # boolean - number of revolving credit cards <12mths, full of NA
           open_rv_24m, ## boolean - number of revolving credit cards <24mths, full of NA
           max_bal_bc, # boolean - Maximum current balance owed on all revolving accounts, full of NA
           all_util, # boolean - Balance to credit limit on all trades
           total_rev_hi_lim, # boolean - Total revolving high credit/credit limit, full of NA
           inq_fi, # boolean - Number of personal finance inquiries, full of NA
           total_cu_tl, # boolean - Number of finance trades, full of NA
           inq_last_12m, # boolean - Number of credit inquiries in past 12 months, full of NA
           acc_open_past_24mths, # boolean -  Number of trades opened in past 24 months, full of NA
           avg_cur_bal, # boolean - Average current balance of all accounts, full of NA
           bc_open_to_buy, # boolean - Total open to buy on revolving bankcards, full of NA
           bc_util, # boolean - Ratio of total current balance to high credit/credit limit for all bankcard accounts, full of NA
           chargeoff_within_12_mths, # dbl - Number of charge-offs within 12 months, 0 for all obs
           delinq_amnt, # dbl - The past-due amount owed for the accounts on which the borrower is now delinquent, 6053 + 27, 0
           mo_sin_old_il_acct, # boolean - Months since oldest bank installment account opened, full of NA
           mo_sin_old_rev_tl_op, # boolean - Months since oldest revolving account opened, full of NA
           mo_sin_rcnt_rev_tl_op, # boolean - Months since most recent revolving account opened, full of NA
           mo_sin_rcnt_tl, # boolean - Months since most recent account opened, full of NA
           mort_acc, # boolean - Number of mortgage accounts, full of NA
           mths_since_recent_bc, # boolean - Months since most recent bankcard account opened, full of NA
           mths_since_recent_bc_dlq, # boolean - Months since most recent bankcard delinquency, full of NA
           mths_since_recent_inq, # boolean - Months since most recent inquiry.
           mths_since_recent_revol_delinq, # boolean - Months since most recent revolving delinquency, full of NA
           num_accts_ever_120_pd, # boolean - Number of accounts ever 120 or more days past due, full of NA
           num_actv_bc_tl, # boolean - 	Number of currently active bankcard accounts, full of NA
           num_actv_rev_tl, # boolean - 	Number of currently active revolving trades, full of NA
           num_bc_sats, # boolean -  Number of satisfactory bankcard accounts, full of NA
           num_bc_tl, # boolean -  Number of bankcard accounts, full of NA
           num_il_tl, # boolean -  Number of installment accounts, full of NA
           num_op_rev_tl, # boolean -  Number of open revolving accounts, full of NA
           num_rev_accts, # boolean - 	Number of revolving accounts, full of NA
           num_rev_tl_bal_gt_0, # boolean -	Number of revolving trades with balance >0, full of NA
           num_sats, # boolean - Number of satisfactory accounts, full of NA
           num_tl_120dpd_2m, # boolean - Number of accounts currently 120 days past due (updated in past 2 months), full of NA
           num_tl_30dpd, # boolean - Number of accounts currently 30 days past due (updated in past 2 months), full of NA
           num_tl_90g_dpd_24m, # boolean - Number of accounts 90 or more days past due in last 24 months, full of NA
           num_tl_op_past_12m, # boolean - Number of accounts opened in past 12 months, full of NA
  )) %>%  view()

# recoveries shows that a charge off has been made, ie deceleration debt is unlikely to be collected, normally at 6 months of no pay
```

# Location of cusotmers who have charged off on laons and initiated recoveries from LC
```{r}
# about 12% of customers are charged off

# relational to state size

# note, cal has 1	California	39,538,223
# 2	Texas	- 29,145,505
# 3	Florida	- 21,538,187
# 4	New York	- 20,201,249
loans %>% 
  filter(recoveries > 0) %>% 
  group_by(state_name) %>% 
  summarise(count = n()) %>% 
  ggplot() +
  aes(x = count, y = reorder(state_name, count)) +
  geom_col()
```

```{r}
#loans_trim %>% 
#  select(-c(mths_since_last_delinq, pub_rec_bankruptcies)) %>% 
#    drop_na() %>% 
#    summarise(across(.fns = ~ sum(is.na(.x))))
#  
#  filter(!is.na(c("loan_amnt", "annual_inc", 
#                  "earliest_cr_line", "delin1_2yrs", 
#                  "total_acc", "inq_last_6mths"))) 
#
#loans_trim %>% 
# summarise(across(.fns = ~ sum(is.na(.x))))

#loan_data_on_ramp <- loan_data %>% 
#  select(-c("verification", "loan_status", ""))
```

```{r}
#loans %>% 
#  distinct(emp_length)

# turning emo_length into numerical
#loans %>% 
#  select(emp_length) %>% 
#  mutate(emp_length = recode(emp_length, "10+ years" = "10", "< 1 year" = "0.92")) %>% 
#  mutate(emp_length = as.numeric(str_remove_all(emp_length, "[a-z]"))) 
```

# Graphs

## looking at volume within loan status categories
```{r}
# looking at volume within loan status categories
loans_trim %>% 
  ggplot() +
  aes(y = loan_status) +
  geom_bar()
```

## †ypes of p2p loans over time
```{r}
#-------------------------------

# counting issue dates
loans_trim %>% 
  count(issue_d)

# counting purpose of loan types
loans_trim %>% 
  count(purpose, sort = T)

loans_trim

# types of p2p loans over time
loans_trim %>% 
  group_by(purpose, issue_d) %>% 
  summarise(count = n()) %>% 
  ggplot() +
  aes(x = issue_d, y = count, colour = purpose) +
  geom_line() 
  
#---------------------------
```

## plot showing volume of negative vs positive loan status
```{r}
# showing types of loan status
loans %>% 
  group_by(loan_status) %>% 
  count(loan_status, sort = T) 

# volume of negatively attributed loans
loans_trim %>% 
  count(defaulted, sort = T)

# plot showing volume of negative vs positive loan status
loans_trim %>% 
  as.factor(defaulted) %>%  
  aes(y = purpose, fill = defaulted ) +
  geom_bar()

# shows that other category is a mixture of repaying debts, credit cards, repairs, building credit, for family members /friends
loans %>% 
  filter(purpose == "other") %>% 
  summarise(desc) %>% 
  view()
```

# LogReg Model
```{r}
library(caret)
library(GGally)

# correlation matrix
loans_trim %>% 
  select(c(inq_last_6mths, loan_amnt, loan_status_flag, fico_range_low, fico_range_high)) %>% 
  ggcorr(label = T, layout.exp = 1)

# scaling data 
loans_data_scaled <- as.data.frame(scale(loan_trim))

mod1 <- glm(loan_status_flag ~ inq_last_6mths,
            data = loan_trim,
            family = binomial((link = "logit")))

summary(mod1)
```


