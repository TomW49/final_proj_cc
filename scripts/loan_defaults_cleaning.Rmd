---
title: "R Notebook"
output: html_notebook
---
# Libraries
```{r}
library(tidyverse)
library(janitor)
library(lubridate)
library(GGally)
library(broom)
library(pROC)
library(modelr)
library(caret)
```

# Reading in data
```{r}
# loading data
loans <- read_csv("../data/lending_club_loans.csv")
grades <- read_csv("../data/grade_info.csv")
states_info <- read_csv("../data/state_names_info.csv")
```

# Joining df's
```{r}
# joining df's
loans <- loans %>% 
  rename(state_abb = addr_state) %>% 
  left_join(states_info, by = "state_abb") %>% 
  left_join(grades, by = "sub_grade") %>% 
  clean_names() 

rm(states_info, grades)
```

# Cleaning
```{r}
# investigating data
summary(loans)

# checking na's
loans %>% 
 summarise(across(.fns = ~ sum(is.na(.x))))

# removing / coalesce na's / tidy up
# remove na's from tax_liens - 148 na's - this also removes 29 consistent NA's
# remove na's from revol_util - 93 na's
# new col, classing loan defaulted if late, charged off or defaulted
# change na's to -1 mths_since_last_delinq + mths_since_last_record as cust have never had both
# change na's to -1 as customers appear to never have had a number of defaults
# changing date var from chr to date
# discovered North Dakota was the NA' value, so changed 
# changed chr cols to factor for model
loans_cleaned <- loans %>%
  filter(if_all(c(id, tax_liens, revol_util), ~ !is.na(.))) %>%
  mutate(defaulted = if_else(  
    loan_status %in% c("Charged Off",
                       "Does not meet the credit policy. Status:Charged Off",
                       "Late (31-120 days)",
                       "Late (16-30 days)",
                       "Default"), "Yes", "No"), 
    .after = loan_status) %>% 
  mutate(mths_since_last_delinq = coalesce(mths_since_last_delinq, -1),
         mths_since_last_record = coalesce(mths_since_last_record, -1),
         pub_rec_bankruptcies = coalesce(pub_rec_bankruptcies, -1)) %>% 
  mutate(issue_d = my(issue_d),       
         earliest_cr_line = my(earliest_cr_line)) %>% 
  mutate(state_name = coalesce(state_name, "North Dakota")) %>% 
  mutate(int_rate = as.numeric(str_remove_all(int_rate, "[%]")),
         term = as.numeric(str_remove_all(term, "[a-z]")),
         zip_code = as.numeric(str_remove_all(zip_code, "[a-z]"))) %>% 
  mutate_if(is_character, as_factor)


# na's remain in emp_title, desc, title, next_pymnt_d, last_pymnt_d, collections_12_mths_ex_med, mths_since_last_major_derog, chargeoff_within_12_mths - more however they are full of NA's (will remove later)
loans_cleaned %>% 
 summarise(across(.fns = ~ sum(is.na(.x))))
```

```{r}
# remove chargeoff_within_12_mths as 42390 - 0, 149 - NA
```   

```{r}
#loans %>% 
#  distinct(emp_length)

# turning emo_length into numerical
#loans %>% 
#  select(emp_length) %>% 
#  mutate(emp_length = recode(emp_length, "10+ years" = "10", "< 1 year" = "0.92")) %>% 
#  mutate(emp_length = as.numeric(str_remove_all(emp_length, "[a-z]"))) 
```

# Splitting data into background_check data
```{r}
# selecting vars used during the background checks of customer

background_checks <- loans_cleaned %>% 
  select(c(defaulted,
           verification_status, # category - verified income
           dti, # dbl - LC ratio on monthly debts/monthly income
           delinq_2yrs,# dbl - The number of 30+  delinquency in the borrower's credit file for the past 2 years
           earliest_cr_line, # dbl - The month the borrower's earliest reported credit line was opened
           fico_range_low, # dbl - credit score at loan origin
           inq_last_6mths, # dbl - The number of inquiries in past 6 months (excluding auto and mortgage inquiries)
           mths_since_last_delinq, # dbl - The number of months since the borrower's last delinquency.(lc??)
           mths_since_last_record, # The number of months since the last public record.
           open_acc, # dbl - The number of open credit lines in the borrower's credit file.
           pub_rec, # dbl - The number of open credit lines in the borrower's credit file.
           revol_bal, # dbl - Total credit revolving balance  unpaid credit at the end of a billing cycle
           revol_util, # chr - %, amount of credit the borrower is using relative to all available revolving credit
           total_acc, # dbl - The total number of credit lines currently in the borrower's credit file
           open_rv_12m, # boolean - number of revolving credit cards <12mths, full of NA
           open_rv_24m, ## boolean - number of revolving credit cards <24mths, full of NA
           max_bal_bc, # boolean - Maximum current balance owed on all revolving accounts, full of NA
           all_util, # boolean - Balance to credit limit on all trades
           total_rev_hi_lim, # boolean - Total revolving high credit/credit limit, full of NA
           inq_fi, # boolean - Number of personal finance inquiries, full of NA
           total_cu_tl, # boolean - Number of finance trades, full of NA
           inq_last_12m, # boolean - Number of credit inquiries in past 12 months, full of NA
           acc_open_past_24mths, # boolean -  Number of trades opened in past 24 months, full of NA
           avg_cur_bal, # boolean - Average current balance of all accounts, full of NA
           bc_open_to_buy, # boolean - Total open to buy on revolving bankcards, full of NA
           bc_util, # boolean - Ratio of total current balance to high credit/credit limit for all bankcard accounts, full of NA
           chargeoff_within_12_mths, # dbl - Number of charge-offs within 12 months, 0 for all obs
           delinq_amnt, # dbl - The past-due amount owed for the accounts on which the borrower is now delinquent, 6053 + 27, 0
           mo_sin_old_il_acct, # boolean - Months since oldest bank installment account opened, full of NA
           mo_sin_old_rev_tl_op, # boolean - Months since oldest revolving account opened, full of NA
           mo_sin_rcnt_rev_tl_op, # boolean - Months since most recent revolving account opened, full of NA
           mo_sin_rcnt_tl, # boolean - Months since most recent account opened, full of NA
           mort_acc, # boolean - Number of mortgage accounts, full of NA
           mths_since_recent_bc, # boolean - Months since most recent bankcard account opened, full of NA
           mths_since_recent_bc_dlq, # boolean - Months since most recent bankcard delinquency, full of NA
           mths_since_recent_inq, # boolean - Months since most recent inquiry.
           mths_since_recent_revol_delinq, # boolean - Months since most recent revolving delinquency, full of NA
           num_accts_ever_120_pd, # boolean - Number of accounts ever 120 or more days past due, full of NA
           num_actv_bc_tl, # boolean - 	Number of currently active bankcard accounts, full of NA
           num_actv_rev_tl, # boolean - 	Number of currently active revolving trades, full of NA
           num_bc_sats, # boolean -  Number of satisfactory bankcard accounts, full of NA
           num_bc_tl, # boolean -  Number of bankcard accounts, full of NA
           num_il_tl, # boolean -  Number of installment accounts, full of NA
           num_op_rev_tl, # boolean -  Number of open revolving accounts, full of NA
           num_rev_accts, # boolean - 	Number of revolving accounts, full of NA
           num_rev_tl_bal_gt_0, # boolean -	Number of revolving trades with balance >0, full of NA
           num_sats, # boolean - Number of satisfactory accounts, full of NA
           num_tl_120dpd_2m, # boolean - Number of accounts currently 120 days past due (updated in past 2 months), full of NA
           num_tl_30dpd, # boolean - Number of accounts currently 30 days past due (updated in past 2 months), full of NA
           num_tl_90g_dpd_24m, # boolean - Number of accounts 90 or more days past due in last 24 months, full of NA
           num_tl_op_past_12m, # boolean - Number of accounts opened in past 12 months, full of NA
           open_acc_6m,
           open_acc_6m,
           open_il_12m,
           open_il_24m,
           open_il_6m,
           mths_since_rcnt_il, 
           total_bal_il, 
           il_util,
           pct_tl_nvr_dlq,
           pub_rec_bankruptcies,
           tax_liens,
           tot_hi_cred_lim,
           total_bal_ex_mort,
           )) 

# removing variables that are only NA
background_checks_trimmed <- background_checks %>%
  select_if(~ !all(is.na(.)))

# recoveries shows that a charge off has been made, ie deceleration debt is unlikely to be collected, normally at 6 months of no pay
```

# Splitting data into onramp_data 
```{r}
# selecting vars used during on ramp phase of delivering loans
# not including funded/inv due to no use
# using grade rather than sub for correlation affect
onramp_data  <- loans_cleaned %>% 
  select(c(defaulted,
           loan_amnt,
           term,
           int_rate,
           installment,
           grade, # LC assigned loan subgrade, can use grade
           emp_title, # chr - not really useful
           emp_length, # chr - years, should turn to factor and use as bins/dummy
           home_ownership, # chr - binned
           annual_inc, # dbl
           issue_d,
           loan_status,
           pymnt_plan, # chr - turn logical
           desc, # chr - text, no use
           purpose, # chr - binned - turn to factor
           title, # chr - user text to describe loan
           zip_code, # chr - usefull for binning, redacted
           state_name, # chr - turn to factor, no need for abbreviated var
           fico_range_low,
           fico_range_high, 
           application_type, # chr - should bin solo or co-borrower - all IND, some NA
           annual_inc_joint, # remove as all na
           dti_joint, # remove as all na
           verification_status_joint, # remove as all na
           tot_coll_amt, # remove as all na
           tot_cur_bal, # remove as all na
           open_acc_6m, # remove as  as all 
           open_acc_6m, # remove as all na
           open_il_12m, # remove as all na
           open_il_24m, # remove as all na
           open_il_6m, # remove as all na
  ))

# removing variables that are only NA
onramp_data_trimmed <- onramp_data %>%
  select_if(~ !all(is.na(.)))

# removing user entered text data & loan_status as created flag, & pymnt_plan as all n bar 1
# removing fico_range_low to have a higher tolerance for credit rate
# removing application_type as they are all individual
onramp_data_trimmed  <- onramp_data_trimmed %>% 
   select(-c(emp_title, desc, title, loan_status, pymnt_plan, fico_range_low, application_type))
```

# Stats
### % of LC customers classified as defaulting
```{r}
# about 15% of customers are either charged off, late > 16days or have defaulted
loans_cleaned %>% 
  group_by(defaulted) %>% 
  summarise(Count = n(), percentage = Count/nrow(loans_cleaned))
```

# Graphs
### Map showing rate of defaults across USA
```{r}
# str to lower to match mapping library
# creating map
default_rate_per_state %>% 
  select(state_name, defaulted_rate) %>%
  rename(region = state_name, value = defaulted_rate) %>% 
  mutate(region = str_to_lower(region)) %>% 
  choroplethr::state_choropleth(title = "Default Rate Per State")
```

### Location of cusotmers who have charged off on loans and initiated recoveries from LC
```{r}
# proportional to state size
# note, cal has 1	California	39,538,223
# 2	Texas	- 29,145,505
# 3	Florida	- 21,538,187
# 4	New York	- 20,201,249

# total LC loans by state
loans_cleaned %>% 
  group_by(state_name) %>% 
  summarise(count = n()) %>% 
  ggplot() +
  aes(x = count, y = reorder(state_name, count)) +
  geom_col()

# total defaulted loans by state 
loans_cleaned %>% 
  filter(defaulted == T) %>% 
  group_by(state_name) %>% 
  summarise(count = n()) %>% 
  ggplot() +
  aes(x = count, y = reorder(state_name, count)) +
  geom_col()

# total ratio of defaulted per state
default_rate_per_state <- loans_cleaned %>%
  group_by(state_name) %>%
  summarise(count = n(), defaulted_rate = sum(defaulted == T) / n()) %>% 
  arrange(desc(defaulted_rate))

# shows Nebraska has highest default rate although small proportion
loans_cleaned %>%
  group_by(state_name) %>%
  summarise(count = n(), defaulted_rate = sum(defaulted == T) / n()) %>% 
  arrange(desc(defaulted_rate)) %>% 
  ggplot() +
  aes(x = defaulted_rate, y = reorder(state_name, defaulted_rate)) +
  geom_col() +
  scale_x_continuous(limits =c (0, 1))
```

### looking at volume within loan status categories
```{r}
# looking at volume within loan status categories
loans_cleaned %>% 
  ggplot() +
  aes(y = loan_status) +
  geom_bar()
```

### †ypes of p2p loans over time
```{r}
#-------------------------------
# data from mid 2007 - end 2011

# total volume of LC loans over time
loans_cleaned %>% 
  count(issue_d, sort = T) %>% 
  ggplot() +
  aes(x = issue_d, y = n) +
  geom_line()

# counting purpose of loan types
loans_cleaned %>% 
  count(purpose, sort = T)

# types of p2p loans over time
loans_cleaned %>% 
  group_by(purpose, issue_d) %>% 
  summarise(count = n()) %>% 
  ggplot() +
  aes(x = issue_d, y = count, colour = purpose) +
  geom_line() 
  
#---------------------------
```

### plot showing volume of negative vs positive loan status
```{r}
# showing types of loan status
loans_cleaned %>% 
  group_by(loan_status) %>% 
  count(loan_status, sort = T) 

# volume of negatively attributed loans
loans_cleaned %>% 
  count(defaulted, sort = T)

# plot showing volume of negative vs positive loan status
loans_cleaned %>% 
  as.factor(defaulted) %>%  
  aes(y = purpose, fill = defaulted ) +
  geom_bar()

# shows that other category is a mixture of repaying debts, credit cards, repairs, building credit, for family members /friends
loans_cleaned %>% 
  filter(purpose == "other") %>% 
  summarise(desc) %>% 
  view()
```

# LogReg Model
```{r}
library(caret)
library(GGally)

# correlation matrix
loans_trim %>% 
  select(c(inq_last_6mths, loan_amnt, loan_status_flag, fico_range_low, fico_range_high)) %>% 
  ggcorr(label = T, layout.exp = 1)

# scaling data 
loans_data_scaled <- as.data.frame(scale(loan_trim))

mod1 <- glm(loan_status_flag ~ inq_last_6mths,
            data = loan_trim,
            family = binomial((link = "logit")))

summary(mod1)
```

### Setting up correlations
```{r}
# splitting df down to compare easily 
split1 <- onramp_data_trimmed %>% 
  select(defaulted, loan_amnt, term, int_rate, installment)

split2 <-  onramp_data_trimmed %>% 
  select(defaulted, grade, emp_length, home_ownership, annual_inc)

split3<- onramp_data_trimmed %>% 
  select(defaulted, issue_d, purpose, zip_code, state_name, fico_range_high)
```

### ggpairs()
```{r}
# defaulted + term(cat) > int_rate > loan_amnt 
split1 %>% 
  ggpairs()

# defaulted + annual_inc(cont) > home_ownership > emp_length
# b-grades are most likely to default
# lower income customers are more likely to default
split2 %>% 
  ggpairs()

# defaulted + fico_range_high(cat) > purpose (cat)
split3 %>% 
  ggpairs(cardinality_threshold = NULL)
```

### Creating models
```{r}
# categorical
mod1_1pred_term <- glm(defaulted ~ term, 
                                  data = onramp_data_trimmed, 
                                  family = binomial(link = 'logit'))

# continuous
mod2_1pred_annual_inc <- glm(defaulted ~ annual_inc, 
                                  data = onramp_data_trimmed, 
                                  family = binomial(link = 'logit'))

# categorical
mod3_1pred_purpose <- glm(defaulted ~ purpose, 
                                  data = onramp_data_trimmed, 
                                  family = binomial(link = 'logit'))

# all p-values are below 0, so tests are significant 
clean_names(tidy(mod1_1pred_term))
clean_names(tidy(mod2_1pred_annual_inc))
clean_names(tidy(mod3_1pred_purpose))

clean_names(glance(mod1_1pred_term))
clean_names(glance(mod2_1pred_annual_inc))
clean_names(glance(mod3_1pred_purpose))
```

### ROC curves
```{r}
onramp_data_trimmed_with_mod1 <- onramp_data_trimmed %>%
  add_predictions(mod1_1pred_term, type = "response")

onramp_data_trimmed_with_mod2 <- onramp_data_trimmed %>%
  add_predictions(mod2_1pred_annual_inc, type = "response")

onramp_data_trimmed_with_mod3 <- onramp_data_trimmed %>%
  add_predictions(mod3_1pred_purpose, type = "response")

roc_obj_mod1 <- onramp_data_trimmed_with_mod1  %>%
  roc(response = defaulted, predictor = pred)

roc_obj_mod2 <- onramp_data_trimmed_with_mod2  %>%
  roc(response = defaulted, predictor = pred)

roc_obj_mod3 <- onramp_data_trimmed_with_mod3  %>%
  roc(response = defaulted, predictor = pred)

roc_curve <- ggroc(
  data = list(
    mod1 = roc_obj_mod1, 
    mod2 = roc_obj_mod2,
    mod3 = roc_obj_mod3
  ), 
  legacy.axes = TRUE) +
  coord_fixed()

roc_curve

# mod1 using term of loan seems out the bunch to be the best classifier as its "curve" is closest to the top left corner. Not really over the diagonal line for a random classifier for threshold values though...
```

```{r}
auc(roc_obj_mod1)
auc(roc_obj_mod2)
auc(roc_obj_mod3)
```

### Cross validation, using a test and a train set
```{r}
train_control <- trainControl(method = "repeatedcv", 
                              number = 5,
                              repeats = 100,
                              savePredictions = TRUE, 
                              classProbs = TRUE, 
                              summaryFunction = twoClassSummary)
```

```{r}
mod1_1pred_term_cv <- train(mod1_1pred_term$formula,
                                       data = onramp_data_trimmed,
                                       trControl = train_control,
                                       method = "glm",
                                       family = binomial(link = 'logit'))
```

```{r}
mod2_1pred_annual_inc_cv <- train(mod2_1pred_annual_inc$formula,
                              data = onramp_data_trimmed,
                              trControl = train_control,
                              method = "glm",
                              family = binomial(link = 'logit'))
```

```{r}
mod3_1pred_purpose_cv <- train(mod3_1pred_purpose$formula,
                           data = onramp_data_trimmed,
                           trControl = train_control,
                           method = "glm",
                           family = binomial(link = 'logit'))
```

```{r}
# near enough same AUC as when used on full data set - with one classifier hard to overfit
mod1_1pred_term_cv$results
mod2_1pred_annual_inc_cv$results
mod3_1pred_purpose_cv$results
```

### Interpretation of the fitted coefficient with odds ratio
```{r}
coeff <- clean_names(tidy(mod1_1pred_term)) %>%
  filter(term == "term") %>%
  select(estimate)
coeff
```

```{r}
# this shows the odd of defaulting on a loan are increased by multiplication by a factor of 1.03
odds_ratio <- exp(coeff * 1)
odds_ratio
```

# Log Reg with all potential predictors
```{r}
mod4_all_preds <- glm(defaulted ~ ., 
                      data = onramp_data_trimmed, 
                      family = binomial(link = 'logit'))

clean_names(tidy(mod4_all_preds)) %>%
  select(term, p_value) %>%
  filter(p_value > 0.05)
```

```{r}
onramp_data_trimmed_with_mod4 <- onramp_data_trimmed %>%
  add_predictions(mod4_all_preds, type = "response")

roc_obj_mod4 <- onramp_data_trimmed_with_mod4  %>%
  roc(response = defaulted, predictor = pred)

ggroc(roc_obj_mod4) +
  coord_fixed()

# AUC and ROC curve could be better..
auc(roc_obj_mod4)
```

```{r}
mod4_all_preds_cv <- train(defaulted ~ .,
                           data = onramp_data_trimmed,
                           trControl = train_control,
                           method = "glm",
                           family = binomial(link = 'logit'))
```


